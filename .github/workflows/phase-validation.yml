name: Phase Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  phase3-convergence:
    name: Phase 3 Convergence Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Phase 3 convergence test
      run: |
        python test_phase3_convergence.py
      continue-on-error: false
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: phase3-convergence-results
        path: |
          test_phase3_convergence.py
        retention-days: 7

  phase4-freeze:
    name: Phase 4 Freeze Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Phase 4 freeze validation
      run: |
        python test_phase4_freeze.py
      continue-on-error: false
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: phase4-freeze-results
        path: |
          test_phase4_freeze.py
        retention-days: 7

  full-system-test:
    name: Full System Integration Test
    runs-on: ubuntu-latest
    needs: [phase3-convergence, phase4-freeze]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run full system test (multi-run mode)
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from main import run_phase0_finite, run_phase1, run_phase2_multi_run, run_phase3_multi_run, run_phase4_multi_run
        
        # Run full pipeline
        NUM_RUNS = 3
        residue_sequences = []
        phase1_metrics_list = []
        
        for i in range(NUM_RUNS):
            residues = run_phase0_finite()
            phase1_metrics = run_phase1(residues)
            residue_sequences.append(residues)
            phase1_metrics_list.append(phase1_metrics)
        
        phase2_metrics = run_phase2_multi_run(residue_sequences, phase1_metrics_list)
        phase3_metrics = run_phase3_multi_run(residue_sequences, phase1_metrics_list, phase2_metrics)
        
        if phase2_metrics is not None and phase3_metrics is not None:
            phase4_metrics = run_phase4_multi_run(phase2_metrics, phase3_metrics)
            print('Full system test: SUCCESS')
            print(f'Phase 2 identities: {len(phase2_metrics.get(\"identity_mappings\", {}))}')
            print(f'Phase 3 relations: {len(phase3_metrics.get(\"persistent_relation_hashes\", set()))}')
            if phase4_metrics:
                print(f'Phase 4 aliases: {phase4_metrics.get(\"identity_alias_count\", 0)} identities, {phase4_metrics.get(\"relation_alias_count\", 0)} relations')
        else:
            print('Full system test: FAILED - Phase 2 or Phase 3 returned None')
            sys.exit(1)
        "
