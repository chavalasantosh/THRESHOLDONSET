name: Module Development

on:
  push:
    branches: [ develop, feature/*, module/* ]
    paths:
      - 'src/**'
      - 'main.py'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'main.py'

jobs:
  module-test:
    name: Module Development Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: ['phase0', 'phase1', 'phase2', 'phase3', 'phase4']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test Module ${{ matrix.module }}
      run: |
        python -c "
        import sys
        import os
        sys.path.insert(0, 'src')
        try:
            if '${{ matrix.module }}' == 'phase0':
                from phase0.phase0 import phase0
                print('Phase 0 module: OK')
            elif '${{ matrix.module }}' == 'phase1':
                from phase1.phase1 import phase1
                print('Phase 1 module: OK')
            elif '${{ matrix.module }}' == 'phase2':
                from phase2.phase2 import phase2_multi_run
                print('Phase 2 module: OK')
            elif '${{ matrix.module }}' == 'phase3':
                from phase3.phase3 import phase3_multi_run
                print('Phase 3 module: OK')
            elif '${{ matrix.module }}' == 'phase4':
                from phase4.phase4 import phase4
                print('Phase 4 module: OK')
        except Exception as e:
            print(f'Module test failed: {e}')
            sys.exit(1)
        "
    
    - name: Verify Module Structure
      run: |
        MODULE_DIR="src/${{ matrix.module }}"
        if [ -d "$MODULE_DIR" ]; then
          echo "Module directory exists: $MODULE_DIR"
          find "$MODULE_DIR" -name "*.py" -not -path "*/__pycache__/*" | head -5
        else
          echo "Module directory not found: $MODULE_DIR"
          exit 1
        fi
    
    - name: Check Module Dependencies
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        module = '${{ matrix.module }}'
        if module == 'phase0':
            # Phase 0 should have minimal dependencies
            import phase0.phase0
            print('Phase 0 dependencies: OK')
        elif module == 'phase1':
            import phase1.phase1
            print('Phase 1 dependencies: OK')
        elif module == 'phase2':
            import phase2.phase2
            print('Phase 2 dependencies: OK')
        elif module == 'phase3':
            import phase3.phase3
            print('Phase 3 dependencies: OK')
        elif module == 'phase4':
            import phase4.phase4
            print('Phase 4 dependencies: OK')
        "
    
    - name: Module Integration Test
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from main import run_phase0_finite, run_phase1, run_phase2_multi_run, run_phase3_multi_run, run_phase4_multi_run
        print('All module integrations: OK')
        "

  module-validation:
    name: Module Validation
    runs-on: ubuntu-latest
    needs: module-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Validate Module Freeze Status
      run: |
        for phase in phase0 phase1 phase2 phase3 phase4; do
          FREEZE_FILE="src/$phase/$phase/PHASE${phase:5}_FREEZE.md"
          if [ -f "$FREEZE_FILE" ]; then
            echo "✓ $phase freeze declaration found"
          else
            echo "⚠ $phase freeze declaration missing"
          fi
        done
    
    - name: Check Module Documentation
      run: |
        for phase in phase0 phase1 phase2 phase3 phase4; do
          README_FILE="src/$phase/README.md"
          if [ -f "$README_FILE" ]; then
            echo "✓ $phase README found"
          else
            echo "⚠ $phase README missing"
          fi
        done
